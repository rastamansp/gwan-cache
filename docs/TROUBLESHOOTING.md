# Guia de Troubleshooting - Gwan Cache

## üö® Problemas Comuns e Solu√ß√µes

Este documento cont√©m solu√ß√µes para os problemas mais frequentes encontrados na administra√ß√£o do sistema de cache Redis.

## üìã √çndice de Problemas

1. [Problemas de Inicializa√ß√£o](#problemas-de-inicializa√ß√£o)
2. [Problemas de Mem√≥ria](#problemas-de-mem√≥ria)
3. [Problemas de Performance](#problemas-de-performance)
4. [Problemas de Conectividade](#problemas-de-conectividade)
5. [Problemas de Persist√™ncia](#problemas-de-persist√™ncia)
6. [Problemas de Seguran√ßa](#problemas-de-seguran√ßa)
7. [Problemas de Backup/Restore](#problemas-de-backuprestore)

## üöÄ Problemas de Inicializa√ß√£o

### Redis n√£o inicia

**Sintomas:**
- Container n√£o sobe
- Erro de configura√ß√£o
- Porta j√° em uso

**Diagn√≥stico:**
```bash
# Verificar logs do container
docker-compose logs redis

# Verificar se a porta est√° em uso
netstat -tulpn | grep :6379
# ou no Windows
netstat -an | findstr :6379

# Verificar configura√ß√£o
docker-compose config
```

**Solu√ß√µes:**

1. **Porta em uso:**
   ```bash
   # Encontrar processo usando a porta
   lsof -i :6379
   # ou no Windows
   netstat -ano | findstr :6379
   
   # Matar processo ou alterar porta no docker-compose.yml
   ```

2. **Erro de configura√ß√£o:**
   ```bash
   # Verificar sintaxe do redis.conf
   docker-compose exec redis redis-server --test-config /usr/local/etc/redis/redis.conf
   
   # Verificar permiss√µes do arquivo
   ls -la config/redis.conf
   ```

3. **Problemas de volume:**
   ```bash
   # Recriar volumes
   docker-compose down -v
   docker-compose up -d
   ```

### Redis Commander n√£o acess√≠vel

**Sintomas:**
- Interface web n√£o carrega
- Erro de autentica√ß√£o
- Timeout de conex√£o

**Diagn√≥stico:**
```bash
# Verificar se o container est√° rodando
docker-compose ps redis-commander

# Verificar logs
docker-compose logs redis-commander

# Testar conectividade
curl http://localhost:8081
```

**Solu√ß√µes:**

1. **Problema de conectividade:**
   ```bash
   # Verificar se Redis est√° acess√≠vel
   docker-compose exec redis-commander ping redis
   
   # Reiniciar commander
   docker-compose restart redis-commander
   ```

2. **Problema de autentica√ß√£o:**
   ```bash
   # Verificar vari√°veis de ambiente
   docker-compose exec redis-commander env | grep REDIS
   
   # Recriar container com novas credenciais
   docker-compose down redis-commander
   docker-compose up -d redis-commander
   ```

## üíæ Problemas de Mem√≥ria

### Out of Memory (OOM)

**Sintomas:**
- Erro "OOM command not allowed"
- Redis rejeita comandos
- Performance degradada

**Diagn√≥stico:**
```bash
# Verificar uso de mem√≥ria
redis-cli info memory

# Verificar configura√ß√£o de mem√≥ria
redis-cli config get maxmemory

# Verificar pol√≠tica de eviction
redis-cli config get maxmemory-policy
```

**Solu√ß√µes:**

1. **Aumentar mem√≥ria:**
   ```bash
   # Editar docker-compose.yml
   # Adicionar: - maxmemory=4gb
   
   # Ou via comando
   redis-cli config set maxmemory 4gb
   ```

2. **Otimizar dados:**
   ```bash
   # Encontrar keys grandes
   redis-cli --bigkeys
   
   # Limpar keys desnecess√°rias
   redis-cli --scan --pattern "temp:*" | xargs redis-cli del
   ```

3. **Ajustar pol√≠tica de eviction:**
   ```bash
   # Para dados que podem ser recriados
   redis-cli config set maxmemory-policy allkeys-lru
   
   # Para dados cr√≠ticos
   redis-cli config set maxmemory-policy volatile-lru
   ```

### Fragmenta√ß√£o de Mem√≥ria

**Sintomas:**
- Alto uso de mem√≥ria sem dados correspondentes
- `mem_fragmentation_ratio` > 1.5

**Diagn√≥stico:**
```bash
# Verificar fragmenta√ß√£o
redis-cli info memory | grep mem_fragmentation_ratio

# Verificar uso real vs alocado
redis-cli info memory | grep -E "(used_memory_human|used_memory_rss_human)"
```

**Solu√ß√µes:**

1. **Restart do Redis:**
   ```bash
   # Fazer backup primeiro
   ./scripts/backup.sh
   
   # Restart
   docker-compose restart redis
   ```

2. **Limpeza manual:**
   ```bash
   # For√ßar limpeza de mem√≥ria
   redis-cli memory purge
   ```

## ‚ö° Problemas de Performance

### Alta Lat√™ncia

**Sintomas:**
- Comandos lentos
- Timeouts na aplica√ß√£o
- Usu√°rios reclamando de lentid√£o

**Diagn√≥stico:**
```bash
# Verificar lat√™ncia
redis-cli --latency

# Verificar comandos lentos
redis-cli slowlog get 10

# Monitorar comandos em tempo real
redis-cli monitor
```

**Solu√ß√µes:**

1. **Otimizar comandos:**
   ```bash
   # Evitar KEYS *, usar SCAN
   redis-cli --scan --pattern "user:*"
   
   # Usar pipelines para opera√ß√µes em lote
   # Evitar opera√ß√µes bloqueantes
   ```

2. **Otimizar configura√ß√£o:**
   ```bash
   # Aumentar timeout
   redis-cli config set timeout 300
   
   # Otimizar TCP
   redis-cli config set tcp-keepalive 60
   ```

3. **Escalar recursos:**
   ```bash
   # Aumentar CPU/mem√≥ria no docker-compose.yml
   # Considerar Redis Cluster
   ```

### Baixo Throughput

**Sintomas:**
- Poucos comandos por segundo
- Aplica√ß√£o lenta
- CPU alta

**Diagn√≥stico:**
```bash
# Verificar ops por segundo
redis-cli info stats | grep instantaneous_ops_per_sec

# Verificar uso de CPU
docker stats gwan-cache-redis

# Verificar conex√µes
redis-cli info clients
```

**Solu√ß√µes:**

1. **Otimizar aplica√ß√£o:**
   - Usar connection pooling
   - Implementar pipelines
   - Evitar opera√ß√µes s√≠ncronas desnecess√°rias

2. **Otimizar Redis:**
   ```bash
   # Aumentar limite de conex√µes
   redis-cli config set maxclients 10000
   
   # Otimizar persist√™ncia
   redis-cli config set save ""
   ```

## üåê Problemas de Conectividade

### Aplica√ß√£o n√£o consegue conectar

**Sintomas:**
- Erro de conex√£o na aplica√ß√£o
- Timeout de conex√£o
- "Connection refused"

**Diagn√≥stico:**
```bash
# Verificar se Redis est√° rodando
docker-compose ps redis

# Testar conectividade
telnet localhost 6379
# ou
nc -zv localhost 6379

# Verificar logs do Redis
docker-compose logs redis | grep -i error
```

**Solu√ß√µes:**

1. **Problema de rede:**
   ```bash
   # Verificar firewall
   sudo ufw status
   # ou no Windows
   netsh advfirewall show allprofiles
   
   # Verificar bind address
   redis-cli config get bind
   ```

2. **Problema de autentica√ß√£o:**
   ```bash
   # Verificar senha
   redis-cli -a your_password ping
   
   # Resetar senha se necess√°rio
   redis-cli config set requirepass new_password
   ```

### Muitas conex√µes

**Sintomas:**
- Erro "max number of clients reached"
- Aplica√ß√£o lenta
- Conex√µes n√£o fechadas

**Diagn√≥stico:**
```bash
# Verificar conex√µes ativas
redis-cli info clients

# Verificar limite
redis-cli config get maxclients

# Listar conex√µes
redis-cli client list
```

**Solu√ß√µes:**

1. **Aumentar limite:**
   ```bash
   redis-cli config set maxclients 10000
   ```

2. **Otimizar aplica√ß√£o:**
   - Implementar connection pooling
   - Fechar conex√µes adequadamente
   - Usar conex√µes persistentes

3. **Limpar conex√µes √≥rf√£s:**
   ```bash
   # Matar conex√µes idle
   redis-cli client list | grep idle= | awk '{print $2}' | cut -d= -f2 | xargs -I {} redis-cli client kill id {}
   ```

## üíø Problemas de Persist√™ncia

### Dados perdidos ap√≥s restart

**Sintomas:**
- Cache vazio ap√≥s reinicializa√ß√£o
- Dados n√£o persistem
- Backup vazio

**Diagn√≥stico:**
```bash
# Verificar configura√ß√£o de persist√™ncia
redis-cli config get save
redis-cli config get appendonly

# Verificar √∫ltimo save
redis-cli info persistence | grep rdb_last_save_time

# Verificar arquivos de persist√™ncia
docker-compose exec redis ls -la /data/
```

**Solu√ß√µes:**

1. **Habilitar persist√™ncia:**
   ```bash
   # RDB
   redis-cli config set save "900 1 300 10 60 10000"
   
   # AOF
   redis-cli config set appendonly yes
   ```

2. **For√ßar save:**
   ```bash
   # Save s√≠ncrono (bloqueia)
   redis-cli save
   
   # Save ass√≠ncrono (n√£o bloqueia)
   redis-cli bgsave
   ```

3. **Verificar permiss√µes:**
   ```bash
   # Verificar permiss√µes do diret√≥rio
   docker-compose exec redis ls -la /data/
   
   # Corrigir permiss√µes se necess√°rio
   docker-compose exec redis chmod 755 /data
   ```

### AOF corrompido

**Sintomas:**
- Redis n√£o inicia
- Erro de AOF
- Dados inconsistentes

**Diagn√≥stico:**
```bash
# Verificar logs de erro
docker-compose logs redis | grep -i aof

# Verificar integridade do AOF
redis-cli --rdb /tmp/test.rdb
```

**Solu√ß√µes:**

1. **Reparar AOF:**
   ```bash
   # Fazer backup do AOF corrompido
   docker cp gwan-cache-redis:/data/appendonly.aof ./backups/
   
   # Tentar reparar
   redis-check-aof --fix /data/appendonly.aof
   ```

2. **Usar RDB como fallback:**
   ```bash
   # Desabilitar AOF temporariamente
   redis-cli config set appendonly no
   
   # Usar apenas RDB
   redis-cli config set save "60 1000"
   ```

## üîí Problemas de Seguran√ßa

### Acesso n√£o autorizado

**Sintomas:**
- Dados acessados sem autentica√ß√£o
- Comandos executados por usu√°rios n√£o autorizados
- Logs de acesso suspeitos

**Diagn√≥stico:**
```bash
# Verificar configura√ß√£o de senha
redis-cli config get requirepass

# Verificar comandos renomeados
redis-cli config get rename-command

# Verificar logs de acesso
docker-compose logs redis | grep -i auth
```

**Solu√ß√µes:**

1. **Configurar autentica√ß√£o:**
   ```bash
   # Definir senha forte
   redis-cli config set requirepass "strong_password_here"
   
   # Reiniciar para aplicar
   docker-compose restart redis
   ```

2. **Renomear comandos perigosos:**
   ```bash
   # Editar redis.conf
   # rename-command FLUSHDB ""
   # rename-command FLUSHALL ""
   # rename-command CONFIG ""
   ```

3. **Configurar ACL (Redis 6+):**
   ```bash
   # Criar usu√°rio com permiss√µes limitadas
   redis-cli acl setuser appuser on >apppassword ~app:* &* +@read +@write
   ```

### Vazamento de dados

**Sintomas:**
- Dados sens√≠veis expostos
- Logs cont√™m informa√ß√µes confidenciais
- Acesso n√£o auditado

**Solu√ß√µes:**

1. **Auditar acesso:**
   ```bash
   # Habilitar logs de comandos
   redis-cli config set notify-keyspace-events Ex
   
   # Monitorar comandos perigosos
   redis-cli monitor | grep -E "(FLUSH|CONFIG|DEBUG)"
   ```

2. **Criptografar dados sens√≠veis:**
   - Implementar criptografia na aplica√ß√£o
   - Usar TLS para conex√µes
   - N√£o armazenar dados sens√≠veis em texto plano

## üíæ Problemas de Backup/Restore

### Backup falha

**Sintomas:**
- Script de backup retorna erro
- Arquivo de backup vazio
- Falta de espa√ßo em disco

**Diagn√≥stico:**
```bash
# Verificar espa√ßo em disco
df -h

# Verificar permiss√µes
ls -la backups/

# Verificar logs do backup
./scripts/backup.sh 2>&1 | tee backup.log
```

**Solu√ß√µes:**

1. **Liberar espa√ßo:**
   ```bash
   # Limpar backups antigos
   find backups/ -name "*.gz" -mtime +30 -delete
   
   # Limpar logs do Docker
   docker system prune -f
   ```

2. **Corrigir permiss√µes:**
   ```bash
   # Criar diret√≥rio se n√£o existir
   mkdir -p backups/
   
   # Corrigir permiss√µes
   chmod 755 backups/
   ```

3. **Backup manual:**
   ```bash
   # Backup direto
   docker-compose exec redis redis-cli bgsave
   docker cp gwan-cache-redis:/data/dump.rdb ./backups/manual_$(date +%Y%m%d_%H%M%S).rdb
   ```

### Restore falha

**Sintomas:**
- Dados n√£o restaurados
- Redis n√£o inicia ap√≥s restore
- Inconsist√™ncia de dados

**Diagn√≥stico:**
```bash
# Verificar integridade do backup
file backups/redis_backup_*.rdb.gz

# Verificar logs do restore
./scripts/restore.sh 2>&1 | tee restore.log
```

**Solu√ß√µes:**

1. **Verificar backup:**
   ```bash
   # Descomprimir e verificar
   gunzip -t backups/redis_backup_*.rdb.gz
   
   # Verificar tamanho
   ls -la backups/
   ```

2. **Restore manual:**
   ```bash
   # Parar Redis
   docker-compose stop redis
   
   # Copiar backup
   docker cp backups/redis_backup_*.rdb gwan-cache-redis:/data/dump.rdb
   
   # Iniciar Redis
   docker-compose start redis
   ```

3. **Verificar integridade:**
   ```bash
   # Verificar se Redis est√° funcionando
   redis-cli ping
   
   # Verificar dados
   redis-cli info keyspace
   ```

## üÜò Procedimentos de Emerg√™ncia

### Redis Completamente Indispon√≠vel

1. **Diagn√≥stico R√°pido (2 minutos):**
   ```bash
   docker-compose ps
   docker-compose logs redis --tail 50
   docker stats gwan-cache-redis
   ```

2. **Restart de Emerg√™ncia (5 minutos):**
   ```bash
   docker-compose restart redis
   sleep 10
   redis-cli ping
   ```

3. **Recovery Completo (15 minutos):**
   ```bash
   ./scripts/restore.sh
   # Selecionar √∫ltimo backup v√°lido
   ```

### Perda Total de Dados

1. **Parar Aplica√ß√£o Imediatamente**
2. **Identificar √öltimo Backup V√°lido**
3. **Restaurar Backup**
4. **Verificar Integridade**
5. **Reiniciar Aplica√ß√£o Gradualmente**

### Ataque de Seguran√ßa

1. **Isolar Sistema:**
   ```bash
   # Parar todos os servi√ßos
   docker-compose down
   
   # Bloquear acesso de rede
   # (configurar firewall)
   ```

2. **Preservar Evid√™ncias:**
   ```bash
   # Fazer backup dos logs
   docker-compose logs > security_incident_$(date +%Y%m%d_%H%M%S).log
   
   # Fazer backup dos dados
   ./scripts/backup.sh
   ```

3. **An√°lise e Corre√ß√£o:**
   - Analisar logs
   - Identificar vulnerabilidade
   - Aplicar corre√ß√µes
   - Testar sistema

## üìû Contatos de Emerg√™ncia

- **Equipe de Infraestrutura**: infra@gwan.com
- **On-call**: +55 11 99999-9999
- **Slack**: #infra-emergency

## üìö Recursos Adicionais

- [Documenta√ß√£o oficial do Redis](https://redis.io/documentation)
- [Redis Troubleshooting Guide](https://redis.io/topics/troubleshooting)
- [Redis Performance Optimization](https://redis.io/topics/benchmarks)

---

**√öltima atualiza√ß√£o**: $(date)
**Vers√£o**: 1.0
**Respons√°vel**: Equipe de Infraestrutura
